Sub InsertFrameAndExtractTDT()
    Dim ws As Worksheet
    Dim lastRow As Long
    Dim frameNumbers() As Long
    Dim i As Long

    Dim summarySheet As Worksheet
    Dim summaryRow As Long
    Dim valueToCopy As Variant
    Dim velocitySum As Double
    Dim velocityCount As Long
    Dim avgVelocity As Double

    ' Create or clear the "Summary" sheet
    On Error Resume Next
    Set summarySheet = ThisWorkbook.Sheets("Summary")
    On Error GoTo 0

    If summarySheet Is Nothing Then
        Set summarySheet = ThisWorkbook.Sheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
        summarySheet.Name = "Summary"
    Else
        summarySheet.Cells.Clear
    End If

    ' Write headers
    summarySheet.Cells(1, 1).Value = "Mouse ID"
    summarySheet.Cells(1, 2).Value = "TotalDistanceTraveled"
    summarySheet.Cells(1, 3).Value = "AverageVelocity"

    summaryRow = 2 ' Start summary from row 2

    ' Loop through each worksheet
    For Each ws In ThisWorkbook.Sheets
        If ws.Name <> "Summary" Then
            ' --- Insert "Frame" Column ---
            lastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
            If lastRow < 2 Then lastRow = 2

            ReDim frameNumbers(1 To lastRow - 1, 1 To 1)
            For i = 1 To lastRow - 1
                frameNumbers(i, 1) = i
            Next i

            ws.Columns("A").Insert Shift:=xlToRight
            With ws.Cells(1, 1)
                .Value = "Frame"
                .Font.Bold = True
                .HorizontalAlignment = xlCenter
            End With

            ws.Range("A2").Resize(UBound(frameNumbers), 1).Value = frameNumbers

            With ws.Range("A2:A" & lastRow)
                .NumberFormat = "0"
                .HorizontalAlignment = xlCenter
                .Borders.LineStyle = xlContinuous
            End With

            ' --- Extract TDT and Avg Velocity ---
            valueToCopy = ws.Cells(lastRow, 2).Value
            velocitySum = Application.WorksheetFunction.Sum(ws.Range("C2:C" & lastRow))
            velocityCount = Application.WorksheetFunction.Count(ws.Range("C2:C" & lastRow))

            If velocityCount > 0 Then
                avgVelocity = velocitySum / velocityCount
            Else
                avgVelocity = 0
            End If

            ' Write to Summary
            summarySheet.Cells(summaryRow, 1).Value = ws.Name
            summarySheet.Cells(summaryRow, 2).Value = valueToCopy
            summarySheet.Cells(summaryRow, 3).Value = avgVelocity

            summaryRow = summaryRow + 1
        End If
    Next ws

    MsgBox "Frames inserted and data extracted to the Summary sheet successfully!"
End Sub
